<!-- aidev/ui/index.html -->
<!doctype html>
<!--
  AIDEV DOM INIT CONTRACT (UPDATED)
  --------------------------------
  The frontend now exposes a single SSE dispatcher: window.handleEvent(event).
  app.js will call init(root) to find a stable set of landmarks using data-aidev-target
  attributes and will register an SSE listener that forwards all incoming events to
  handleEvent(event). Do not add multiple competing SSE consumers; the canonical
  dispatcher is the single source of truth for rendering streamed events.

  Required canonical data-aidev-target names and ids (additive; do not remove IDs or ARIA):
    - app: main application root (main#main-content)
    - input: primary chat input (input#msg)
    - send: send button (button#send)
    - chat-feed: chat message feed (div#chat-feed)
    - planned-changes: review & apply panel (section#planned-changes)
    - recommendations-list: container for recommendation items (fieldset#recommendations-list)
    - banner: status/banner area used by showError (div#status-banner) ‚Äî must exist on page load
    - announcer: live-region announcer for SSE/updates (div#sse-announcer)
    - top-progress: top progress region (div#top-progress)
    - project-root: selected project root sentinel (span#project-root) ‚Äî must exist on page load; app.js will read/modify data-project-root
    - connection-status: accessible connection status element (span#connection-status)
    - conn-retry: retry control (button#conn-retry)
    - events-list: container for streamed backend events (ul#events-list)
    - event-row-template: template used by the canonical SSE dispatcher (template#event-row-template)

  Notes:
    - Add only data-aidev-target attributes where explicitly listed above; keep existing IDs, classes and ARIA attributes.
    - This page remains fully functional with current JS until app.js is migrated to the new contract.

  Editor note: If you change the ids or data-aidev-target names above, update aidev/tools/ui_consistency_check.py
  so the CLI check validates the new selectors.
-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI-Dev-Bot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="color-scheme" content="light dark" />
  <link rel="stylesheet" href="/ui/style.css" />
</head>
<body>
  <!-- Skip link for keyboard users -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Basic no-JS fallback so the page remains readable and navigable without JavaScript -->
  <noscript>
    <div class="no-js-notice no-js-notice--banner">
      This UI requires JavaScript for full functionality. You can still read the page content, but interactive features (chat, live updates, and run controls) will be limited.
    </div>
  </noscript>

  <header role="banner">
    <strong>AI-Dev-Bot</strong>

    <p id="hero-text" class="hero-text">Make safe, tested code changes with simple guided steps.</p>

    <!-- Group navigation and primary actions inside an explicit nav landmark -->
    <nav id="main-nav" role="navigation" aria-label="Main">
      <!-- Single prominent primary CTA placed at the top-most hero region and
           before other focusable controls so it receives the first tab stop. -->
      <button id="primary-start-cta" class="btn btn-primary" type="button" aria-label="Get Started" aria-describedby="hero-text">Get Started</button>

      <!-- Hamburger / nav toggle for small viewports -->
      <button id="nav-toggle" class="btn icon only" type="button" aria-label="Toggle navigation" title="Toggle navigation" aria-expanded="false" aria-controls="sidebar">
        <span aria-hidden="true">‚ò∞</span>
        <span class="visually-hidden">Toggle navigation</span>
      </button>

      <div class="right-actions secondary-hidden">
        <!-- Help button: re-opens onboarding/banner when clicked (app.js will wire behavior) -->
        <button id="btn-help" class="btn ghost" type="button" aria-label="Help" title="Help" data-aidev-target="help-button">Help</button>

        <button id="btn-project" class="btn secondary" type="button" title="Create or select project">Project</button>
        <button id="btn-toggle-map" class="btn ghost" type="button" title="Show/hide project map">Map</button>

        <!-- Theme toggle (JS will set aria-pressed and persist preference) -->
        <button id="theme-toggle" class="btn ghost" type="button" aria-pressed="false" aria-label="Toggle theme" data-aidev-target="theme-toggle">
          <span aria-hidden="true">üåì</span>
          <span class="visually-hidden">Toggle dark / light theme</span>
        </button>
      </div>
    </nav>

    <!-- Advanced toggle: visible control to reveal/hide advanced settings. App.js will
         attach persistent behavior (localStorage key 'advancedMode') and manage the
         document body class 'advanced-open' so CSS can show/hide the section. The toggle
         controls the panel element with id 'advanced-panel' (aria-controls links them). -->
    <div class="advanced-toggle-wrap">
      <button id="advanced-toggle" class="btn ghost" type="button" aria-expanded="false" aria-controls="advanced-panel" title="Show advanced settings">Advanced ‚ñæ</button>
    </div>

    <!-- Top progress replaces noisy badges and gives friendly step feedback -->
    <div id="top-progress" class="top-progress" role="region" aria-label="Run progress" data-aidev-target="top-progress">
      <div class="progress-line">
        <!-- Friendly, human-readable stages. Default: 5 stages. -->
        <div id="top-progress-step" class="progress-step" aria-live="polite">Step 1 of 5 ‚Äî Understanding your project</div>
        <progress id="top-progress-bar" value="20" max="100" aria-label="Overall progress"></progress>
        <small id="top-progress-percent">20%</small>
      </div>
      <!-- Hidden data mapping internal step keys to human labels for tests and JS consumers -->
      <!-- NOTE: This mapping is intentionally non-executing JSON. App.js should read the JSON
           from the element with id="aidev-stage-map" during initialization and provide
           any runtime helpers (for example: updateTopProgress). This keeps the page
           declarative and moves behavioral logic into app.js. -->
      <script id="aidev-stage-map" type="application/json">
{
  "scan_project": "Understanding your project",
  "plan_changes": "Planning changes",
  "draft_edits": "Drafting edits",
  "await_approval": "Waiting for approval",
  "apply_changes": "Applying changes",
  "discovery": "Discovery",
  "targets": "Targets",
  "propose": "Propose",
  "approval": "Approval",
  "apply": "Apply",
  "quality": "Quality"
}
      </script>
    </div>

    <!-- Keep small, muted badges for diagnostics but de-emphasize visually -->
    <span id="session" class="badge muted secondary-hidden" title="Session ID" aria-hidden="true"></span>
    <span id="current-project" class="badge muted secondary-hidden" title="Current project" aria-hidden="true"></span>

    <!-- Project root sentinel: app.js will read and set data-project-root (or textContent).
         This element must exist on initial load so the frontend can include project_root
         in edit/propose/apply requests. Keep it visually hidden and aria-hidden. -->
    <span id="project-root" class="visually-hidden" data-aidev-target="project-root" data-project-root="" aria-hidden="true" title="Selected project root (set by app.js)"></span>
    <!-- DEV NOTE: aidev/ui/app.js MUST read data-project-root from #project-root (fallback to textContent)
         and include a non-empty "project_root" field in all edit-related request payloads (propose/apply/SSE init).
         Example attribute value: data-project-root="/repos/my-team/my-repo"
         Example JS (reference only):
           const el = document.getElementById('project-root');
           const projectRoot = (el && el.dataset && el.dataset.projectRoot) || (el && el.textContent) || '';
           // Ensure payloads include: payload.project_root = projectRoot;
    -->

  </header>

  <!-- Lightweight onboarding banner (additive). App.js will persist dismissal via localStorage ('aidev:onboardingDismissed'). -->
  <div id="onboarding-banner" class="onboarding-banner onboarding-focusable banner" role="region" aria-label="Welcome to AI-Dev-Bot onboarding" tabindex="0" data-aidev-target="onboarding-banner">
    <div class="onboarding-inner">
      <div class="onboarding-message">
        <strong>Welcome to AI-Dev-Bot</strong>
        <span class="muted"> ‚Äî Try the guided workflow to propose safe, test-backed changes to your repo.</span>
      </div>
      <div class="onboarding-actions">
        <button id="onboarding-cta" class="btn btn-primary" type="button" aria-label="Start guided tour">Get started</button>
        <button id="onboarding-dismiss" class="btn ghost" type="button" aria-label="Dismiss onboarding banner">Dismiss</button>
      </div>
    </div>
  </div>

  <!-- Sticky progress shell -->
  <div id="progress-shell" class="progress-shell" role="region" aria-label="Run progress">
    <div class="progress-bar-line">
      <progress id="progress-bar" value="0" max="100" aria-label="Run progress"></progress>
      <small id="progress-label">Idle</small>
    </div>
    <ul id="progress-mini" class="progress-mini" aria-live="polite" aria-label="Current edits"></ul>
  </div>

  <!-- global status bar (SSE + short status text) -->
  <div class="statusbar" role="status" aria-live="polite">
    <span id="conn-dot" class="dot" aria-hidden="true"></span>
    <div class="status-main">
      <div id="status-spinner" class="spinner hidden" aria-hidden="true"></div>
      <small id="status">Ready</small>
      <!-- Connection status text (unobtrusive) -->
      <span id="conn-status" aria-hidden="true">(disconnected)</span>

      <!-- Accessible connection status for SSE (updated by app.js) -->
      <span id="connection-status" role="status" aria-live="polite" class="status-indicator" data-aidev-target="connection-status"><span class="visually-hidden">Disconnected</span></span>

      <!-- Retry control shown when disconnected (app.js will toggle visibility). -->
      <button id="conn-retry" class="btn ghost conn-retry" type="button" data-aidev-target="conn-retry" aria-label="Retry connection" aria-controls="connection-status" hidden aria-hidden="true">Retry</button>
    </div>
  </div>

  <!-- validation / self-heal status banner -->
  <!-- showError will render into [data-aidev-target="banner"]; element must be present on page load -->
  <div id="status-banner" class="status-banner status-banner--hidden" data-aidev-target="banner">
    <span class="status-banner__spinner" aria-hidden="true"></span>
    <span id="status-banner-text"></span>
  </div>

  <!-- Onboarding modal: lightweight, dismissible first-run guide -->
  <div
    id="onboarding-modal"
    class="modal"
    aria-hidden="true"
    role="dialog"
    aria-labelledby="onboarding-title"
    aria-modal="true"
    data-modal="onboarding"
    data-modal-open="false"
    data-aidev-target="onboarding-modal"
    hidden
  >
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-card" role="document" tabindex="-1">
      <h3 id="onboarding-title">Welcome to AI-Dev-Bot</h3>
      <p class="note">A few quick tips to get you started ‚Äî this will only show once.</p>

      <ol>
        <li>
          <strong>What it is:</strong>
          <div class="muted small">An assistant that understands your repo and can suggest safe, test-backed changes. Start by asking a question in the Conversation panel.</div>
        </li>
        <li>
          <strong>How to start:</strong>
          <div class="muted small">Click the main <em>Get Started</em> button below to focus the conversation input and begin ‚Äî the assistant will guide you step-by-step.</div>
        </li>
      </ol>

      <div class="row actions-row">
        <button id="onboarding-skip" class="btn ghost" data-close-modal type="button">Skip</button>
        <button id="onboarding-get-started" class="btn" type="button">Get started</button>
      </div>
    </div>
  </div>

  <main id="main-content" class="layout" role="main" data-aidev-target="app">
    <!-- LEFT: Conversation + diffs -->
    <section class="column column-main" aria-labelledby="chat-title">
      <!-- Chat panel (primary focus) -->
      <section class="card chat-panel" aria-labelledby="chat-title">
        <div class="card-header">
          <div>
            <h2 id="chat-title">Conversation</h2>
            <p class="section-subtitle">
              Ask questions about this repo or tell me what you‚Äôd like to build or change.
            </p>
          </div>
        </div>

        <!-- Run mode selector -->
        <div class="row chat-mode-row">
          <label for="run-mode" class="tool-label">How should I help?</label>
          <select id="run-mode" title="Assistant mode">
            <option value="auto" selected>Auto (decide per message)</option>
            <option value="qa">Q&amp;A only (no edits)</option>
            <option value="analyze">Analyze &amp; plan (no edits)</option>
            <option value="edit">Full edit pass (plan + apply)</option>
          </select>
          <small class="muted small">
            Pick whether you just want answers, a plan, or real code changes.
          </small>
        </div>

        <!-- Chat feed (system/user/assistant bubbles) -->
        <div id="chat-feed" class="chat-feed" role="log" aria-live="polite" aria-atomic="false" aria-label="Conversation" data-aidev-target="chat-feed">
          <!-- Initial assistant bubble so the panel feels like a chat right away -->
          <div class="chat-bubble bubble assistant" role="status" aria-live="polite">
            <div class="bubble-content">
              Hi ‚Äî I‚Äôm your AI dev assistant for this project. Ask me a question about the codebase or
              tell me what you‚Äôd like to change, and I‚Äôll either explain, propose a plan, or suggest edits
              (with your approval).
            </div>
          </div>
          <!-- Example ‚Äúuser‚Äù message to hint at good questions -->
          <div class="chat-bubble bubble user">
            <div class="bubble-content">
              For example: ‚ÄúWhat files power the Q&amp;A mode?‚Äù or ‚ÄúMake the homepage more modern and mobile-friendly.‚Äù
            </div>
          </div>

          <!-- Bot typing indicator (hidden by default, shown by app.js during assistant streaming) -->
          <div id="bot-typing" class="chat-bubble bubble assistant bot-typing visually-hidden" role="status" aria-live="polite" aria-atomic="true">
            <div class="bubble-content">
              <span class="typing-dots" aria-hidden="true">‚Ä¶</span>
              <span class="visually-hidden">Bot is typing‚Ä¶</span>
            </div>
          </div>
        </div>

        <!-- Chat input -->
        <div class="row actions chat-input-row">
          <label for="msg" class="visually-hidden">Message</label>
          <input
            id="msg"
            type="text"
            placeholder="Ask a question about this project or describe what you want to build‚Ä¶"
            data-aidev-target="input"
          />
          <button id="send" class="btn" type="button" data-aidev-target="send">Send</button>
        </div>
        <div class="chat-input-helper">
          <small class="input-helper">
            Example: ‚ÄúWhat should I change to improve the Q&amp;A flow?‚Äù or ‚ÄúAdd a settings page for user profiles.‚Äù
          </small>
        </div>
      </section>

      <!-- Additive: Backend events card (SSE event list, run log, diff preview) -->
      <section id="aidev-events-card" class="card events-panel" role="region" aria-label="Backend events" data-aidev-target="events-panel">
        <div class="card-header">
          <h3 id="aidev-events-title">Backend events</h3>
          <p class="muted small">Live updates from the server (streamed events, logs, and diffs).</p>
        </div>
        <div class="card-body">
          <!-- Live event list: app.js will append entries here -->
          <div id="aidev-events" role="list" aria-live="polite" aria-label="Event list" class="event-list"></div>

          <!-- New SSE anchors (rec: ui-sse-events-display-update) -->
          <!-- rec: ui-sse-events-display-update ‚Äî added #events-panel, #events-list, and #event-row-template so app.js can render SSE events into the UI. -->
          <div id="events-panel" class="events-panel">
            <h4 class="visually-hidden">Streamed events</h4>
            <!-- Empty, semantic list for incoming SSE events. App.js will append <li> items here using #event-row-template. -->
            <ul id="events-list" role="list" aria-live="polite" aria-label="Streamed backend events" data-aidev-target="events-list"></ul>
          </div>

          <!-- New: SSE-driven banner for transient or persistent run errors (dismissible). -->
          <div id="sse-banner" class="status-banner status-banner--hidden" role="status" aria-live="assertive" hidden>
            <span id="sse-banner-text" class="status-banner__text"></span>
            <button id="sse-banner-close" class="btn ghost" type="button" aria-label="Dismiss banner">‚úï</button>
          </div>

          <!-- New: compact SSE progress display (augments top-progress; updated by app.js). -->
          <div id="sse-progress" class="sse-progress aidev-progress" role="region" aria-label="Streamed run progress">
            <div class="sse-progress-line">
              <progress id="sse-progress-bar" value="0" max="100" aria-label="Run stage progress"></progress>
              <small id="sse-progress-percent">0%</small>
            </div>
          </div>

          <!-- New: compact stage timeline (pending ‚Üí active ‚Üí done ‚Üí error). App.js will toggle state classes on each .stage element. -->
          <div id="sse-stage-timeline" class="stage-timeline" data-aidev-target="stage-timeline" role="list" aria-label="Run stages timeline">
            <div id="stage-discovery" class="stage stage--pending stage-badge" role="listitem" data-stage="discovery">Discovery</div>
            <div id="stage-targets" class="stage stage--pending stage-badge" role="listitem" data-stage="targets">Targets</div>
            <div id="stage-propose" class="stage stage--pending stage-badge" role="listitem" data-stage="propose">Propose</div>
            <div id="stage-approval" class="stage stage--pending stage-badge" role="listitem" data-stage="approval">Approval</div>
            <div id="stage-apply" class="stage stage--pending stage-badge" role="listitem" data-stage="apply">Apply</div>
            <div id="stage-quality" class="stage stage--pending stage-badge" role="listitem" data-stage="quality">Quality</div>
          </div>

          <!-- New: Collapsible "Other events" capture for unknown/other SSE types (collapsed by default). -->
          <div id="other-events" class="other-events" aria-label="Other streamed events" aria-expanded="false">
            <button id="other-events-toggle" class="btn ghost" type="button" aria-controls="other-events-content" aria-expanded="false">Other events ‚ñæ</button>
            <div id="other-events-content" hidden>
              <ul id="other-events-list" role="list" aria-live="polite" aria-label="Other backend events"></ul>
            </div>
          </div>

          <!-- Run logs (text output): app.js may append raw lines here -->
          <div id="aidev-log" role="log" aria-live="polite" aria-label="Run log" class="run-log" tabindex="0"></div>

          <!-- Diff preview area for inline diffs sent via SSE -->
          <pre id="aidev-diff" role="region" aria-label="Diff preview" class="diff-preview" tabindex="0">(no diff yet)</pre>

          <!-- Event item template for consistent rendering by app.js -->
          <!-- LEGACY: a previous template was removed in favor of event-row-template (see refactor notes at top). -->

          <!-- NEW: compact row template specifically used by SSE wiring (app.js) -->
          <template id="event-row-template" data-aidev-target="event-row-template">
            <li class="event-row" role="listitem">
              <time class="evt-ts" datetime="" data-event-ts></time>
              <strong class="evt-type" data-event-type></strong>
              <div class="evt-payload monospace" aria-hidden="false" data-event-payload></div>
            </li>
          </template>

          <!-- BACKCOMPAT: some older app.js versions reference #aidev-event-template; keep a simple alias in place to avoid runtime errors. -->
          <template id="aidev-event-template">
            <li class="event-row" role="listitem">
              <time class="evt-ts" datetime="" data-event-ts></time>
              <strong class="evt-type" data-event-type></strong>
              <div class="evt-payload monospace" aria-hidden="false" data-event-payload></div>
            </li>
          </template>

          <!-- Template for rendering a stage item (optional helper for app.js) -->
          <template id="stage-item-template">
            <div class="stage stage--pending" role="listitem" data-stage="">
              <span class="stage-label"></span>
            </div>
          </template>

        </div>
      </section>

      <!-- Planned changes / diffs + approve/reject -->
      <section
        id="planned-changes"
        class="card planned-panel"
        aria-labelledby="planned-title"
        data-aidev-target="planned-changes"
      >
        <div class="card-header planned-header">
          <div>
            <h3 id="planned-title">Review and apply these changes</h3>
            <p class="section-subtitle">
              This run will make <span id="planned-changes-count">0</span> sets of changes.
            </p>
            <p class="section-subtitle auto-approve-help">
              <strong
                class="risk-pill low"
                id="overall-risk-pill"
                title="Estimated overall risk level for this run"
              >
                LOW
              </strong>
              <small class="risk-desc">
                LOW = Safe cosmetic / small content changes.
              </small>
            </p>

            <!-- Global validation summary for this run; updated by app.js -->
            <div
              id="validation-summary"
              class="validation-summary"
              aria-live="polite"
              aria-label="Pre-apply validation status"
            >
              <div class="validation-chips">
                <span
                  class="validation-chip"
                  data-kind="syntax"
                  data-status="pending"
                >
                  Syntax
                </span>
                <span
                  class="validation-chip"
                  data-kind="lint"
                  data-status="pending"
                >
                  Lint
                </span>
                <span
                  class="validation-chip"
                  data-kind="tests"
                  data-status="pending"
                >
                  Tests
                </span>
              </div>
              <small id="validation-summary-note" class="muted">
                Checks will run automatically in a temporary copy of your project before changes are applied.
              </small>
            </div>

            <!-- Post-apply quality checks summary (updated by app.js) -->
            <div
              id="quality-checks-summary"
              class="quality-summary"
              aria-live="polite"
              aria-label="Post-apply quality checks status"
            >
              <span id="quality-checks-icon" class="quality-icon" aria-hidden="true"></span>
              <small id="quality-checks-status" class="muted small">
                No post-apply checks have run yet.
              </small>
            </div>
          </div>
          <div class="planned-actions">
            <label
              class="auto-approve-toggle"
              title="When enabled, the bot applies changes as they‚Äôre ready, without asking for manual approval."
            >
              <input type="checkbox" id="auto-approve-changes" />
              <span>Automatically apply changes as they‚Äôre ready (advanced)</span>
            </label>
            <small class="muted" title="We recommend manual approval for new users">We recommend manual approval for new users.</small>
            <button id="auto-approve-info" class="btn ghost" type="button" title="Recommended to leave manual approval on for new users">‚ÑπÔ∏è</button>
            <!-- Selected project display: updated by app.js; do not remove #project-root sentinel -->
            <span id="selected-project" class="badge" role="status" aria-live="polite" title="Selected project" tabindex="0">No project selected</span>

            <button id="approve-changes-btn" class="btn secondary" type="button" disabled>
              Approve Changes
            </button>
            <button id="reject-changes-btn" class="btn ghost" type="button" disabled>
              Skip
            </button>
            <!-- One-click rollback; JS can enable when a snapshot is available -->
            <button
              id="rollback-last-run-btn"
              class="btn ghost"
              type="button"
              disabled
              title="Restore the project to the snapshot taken before this run (when available)."
            >
              Restore previous snapshot
            </button>
          </div>
        </div>

        <!-- Inline status for edit approvals (updated by app.js) -->
        <div
          id="planned-changes-status"
          class="planned-status muted"
          aria-live="polite"
        ></div>

        <!-- Persistent, in-page recommendations panel
             This is the new primary place recommendations are rendered. It is persistent
             (not a modal) and lives inside the Review & Apply section so clicking outside
             will not dismiss it. App.js can populate #recommendations-list with items. -->
        <div id="recommendations-panel" class="recommendations-panel card" role="region" aria-label="Recommendations" aria-live="polite" hidden>
          <div class="card-header spaced">
            <div class="recommendations-header-left">
              <h4 id="recommendations-title">Recommendations</h4>
              <p class="muted small" id="recommendations-note">All recommendations are selected by default ‚Äî uncheck anything you don‚Äôt want to include in this run.</p>
            </div>
            <div class="recommendations-header-actions">
              <input id="recommendations-search" class="search" type="search" placeholder="Filter by title, summary, or file path‚Ä¶" aria-label="Filter recommendations" />
              <button id="recommendations-select-all" class="btn secondary" type="button" title="Select all recommendations">Select all</button>
              <button id="recommendations-clear" class="btn ghost" type="button" title="Clear all selections">Clear</button>
            </div>
          </div>

          <!-- List of recommendations (populated by app.js). Each item should include a checkbox, title, summary and risk pill. -->
          <fieldset id="recommendations-list" class="rec-list rec-list--inner" role="list" aria-labelledby="recommendations-title" aria-live="polite" data-aidev-target="recommendations-list">
            <!-- Items will be injected here by app.js; see template #rec-template above for structure -->
          </fieldset>

          <!-- Optional summary of the currently selected recommendation(s) -->
          <div id="recommendations-selected-summary" class="plan-selected-summary recommendations-selected-summary">
            <h5>Selected recommendation</h5>
            <p class="muted small">Select a recommendation above to see a quick summary here. This area can highlight highest-impact changes or risk level.</p>
          </div>

          <div class="row actions-row">
            <button id="recommendations-cancel" class="btn ghost" type="button">Cancel</button>
            <button id="recommendations-approve" class="btn" type="button">Approve Selected</button>
          </div>
          <small id="recommendations-status" class="status recommendations-status" aria-live="polite"></small>
        </div>

        <!-- Diff / rationale content injected by app.js -->
        <div id="diffs">
          <!-- Template for per-recommendation panels. App.js can clone and populate this. -->
          <template id="rec-template">
            <article class="recommendation card" role="listitem" data-rec-id="" tabindex="-1">
              <div class="rec-header">
                <div class="rec-header-main">
                  <h4 class="rec-title">Improve progress bar and status messages</h4>
                  <p class="rec-summary">
                    Updates the top progress bar text to show steps and completion %, no backend logic changes.
                  </p>

                  <!-- Per-recommendation risk + validation summary (populated by app.js) -->
                  <div class="rec-meta-row">
                    <span
                      class="risk-pill low rec-risk-pill"
                      data-risk="low"
                      title="Estimated risk level for this recommendation"
                    >
                      LOW RISK
                    </span>
                    <div
                      class="rec-validation"
                      aria-label="Validation status for this recommendation"
                    >
                      <span
                        class="validation-chip"
                        data-kind="syntax"
                        data-status="pending"
                      >
                        Syntax
                      </span>
                      <span
                        class="validation-chip"
                        data-kind="lint"
                        data-status="pending"
                      >
                        Lint
                      </span>
                      <span
                        class="validation-chip"
                        data-kind="tests"
                        data-status="pending"
                      >
                        Tests
                      </span>
                    </div>
                  </div>
                </div>

                <ul class="rec-files" aria-label="Files changed">
                  <li data-path="aidev/ui/index.html">aidev/ui/index.html ‚Äî page layout</li>
                  <li data-path="aidev/ui/style.css">aidev/ui/style.css ‚Äî styles / colors</li>
                </ul>

                <div class="rec-actions">
                  <button class="btn primary approve-rec" data-rec-id="" type="button">Approve this change</button>
                  <button class="btn ghost skip-rec" data-rec-id="" type="button">Skip this change</button>
                </div>

                <details class="rec-details rec-technical">
                  <summary>Show technical details (code diff)</summary>
                  <pre class="diff monospace" aria-hidden="true"></pre>
                </details>
              </div>
            </article>
          </template>

          <!-- Focusable unified diff viewer template (additive). App.js will clone and populate this for single-diff focused view. -->
          <template id="diff-view-template">
            <section class="diff-view" role="region" aria-label="Unified diff preview" tabindex="0">
              <div class="diff-view-controls" aria-hidden="false">
                <button id="diff-toggle-wrap" class="btn ghost" type="button" aria-pressed="false" title="Toggle line wrapping">Toggle wrap</button>
                <button id="diff-copy" class="btn ghost" type="button" title="Copy diff to clipboard">Copy</button>
                <button id="diff-raw" class="btn ghost" type="button" title="View raw diff">Raw</button>
              </div>
              <pre class="diff monospace" tabindex="0" aria-live="polite" aria-label="Unified diff preview"><!-- diff content injected here -->
</pre>
            </section>
          </template>
        </div>
      </section>

      <!-- Run log endpoint sentinel for app.js (ensureTechnicalDetailsPanel creates the actual panel) -->
      <div id="run-log-endpoint-sentinel" data-run-log-endpoint="/api/run-log" hidden></div>
    </section>

    <!-- RIGHT: Project overview, tools, project map -->
    <aside class="column column-sidebar" aria-label="Project overview and tools">
      <!-- Project description panel -->
      <section id="description-section" class="card" aria-labelledby="description-title">
        <div class="description-header">
          <div>
            <h3 id="description-title">Project description</h3>
            <p class="note">
              Edit this to tell the bot what your project is about. (Read-only during a run.)
            </p>
          </div>
          <button id="edit-description" class="btn secondary" type="button">
            Edit description
          </button>
        </div>

        <div id="description-preview" class="description-preview">
          (No description yet. Click ‚ÄúEdit description‚Äù to add one.)
        </div>

        <details id="compiled-brief-section" class="compiled-brief-section empty-brief">
          <summary>AI-compiled brief (read-only)</summary>
          <pre id="compiled-brief" aria-label="AI-compiled project brief">
(The AI-compiled brief will appear here after you save your description.)
          </pre>
        </details>
      </section>

      <!-- Advanced settings container: hidden by default. App.js will read/write
           'advancedMode' in localStorage and toggle document.body.classList.add('advanced-open')
           to reveal this region. This keeps the default UI simple while making advanced
           controls discoverable. -->
      <section id="advanced-panel" class="advanced-settings" hidden aria-hidden="true" role="region" aria-label="Advanced settings" data-panel="advanced" data-panel-open="false">
        <!-- Project tools: collapsed advanced area -->
        <section class="card tools-panel collapsed" aria-label="Project tools">
          <h3 class="tools-title">Project tools (advanced)</h3>

          <div class="tools-grid">
            <!-- Map & cards -->
            <div class="tool-group">
              <h4 class="tool-heading">Project map & cards</h4>
              <div class="row">
                <h5 class="visually-hidden">Project map actions</h5>
                <div class="row">
                  <button id="gen-map" class="btn" type="button" hidden aria-hidden="true">Generate Project Map</button>
                  <small id="map-status" class="status"></small>
                </div>
                <div class="row">
                  <button id="btn-refresh-cards" class="btn secondary" type="button">Refresh Cards</button>
                  <span id="refresh-cards-status" class="status"></span>
                </div>
              </div>
            </div>

            <!-- AI summaries -->
            <div class="tool-group">
              <h4 class="tool-heading">AI summaries</h4>
              <div class="row">
                <label for="ai-model" class="tool-label">AI model</label>
                <select id="ai-model" title="AI model">
                  <option value="">(server default)</option>
                  <option value="gpt-5-mini">gpt-5-mini</option>
                  <option value="gpt-4o-mini">gpt-4o-mini</option>
                  <option value="gpt-4o">gpt-4o</option>
                </select>
              </div>
              <div class="row">
                <button id="btn-ai-summarize-changed" class="btn" type="button">
                  Refresh + AI (changed)
                </button>
                <span id="ai-summarize-status" class="status"></span>
              </div>
              <div class="row">
                <button id="btn-ai-deep" class="btn secondary" type="button">
                  Refresh + AI (deep)
                </button>
                <span id="ai-deep-status" class="status"></span>
              </div>
              <p class="muted small">The bot can re-summarize your project files here. Most users don‚Äôt need this.</p>
            </div>

            <!-- Checks & description shortcut -->
            <div class="tool-group">
              <h4 class="tool-heading">Checks & metadata</h4>
              <div class="row">
                <button id="btn-update-descriptions" class="btn ghost" type="button" hidden aria-hidden="true">
                  Edit description
                </button>
              </div>
              <div class="row">
                <button id="btn-run-checks" class="btn secondary" type="button">
                  Run checks
                </button>
                <span id="checks-status" class="status"></span>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- Project Map / Cards Panel (toggled by header "Map" button) -->
      <section id="map-section" class="card" aria-labelledby="map-title" hidden>
        <div class="card-header">
          <h3 id="map-title">Project Map</h3>
          <div class="right-actions">
            <button id="copy-map" class="btn ghost" type="button" title="Copy JSON to clipboard">Copy JSON</button>
          </div>
        </div>

        <small class="note">
          The map includes the discovered structure and per-file summaries (cards).
        </small>

        <!-- cards summary banner -->
        <div id="cards-summary" class="banner" aria-live="polite">
          files: <strong id="cards-files">0</strong> ‚Ä¢
          changed: <strong id="cards-changed">0</strong> ‚Ä¢
          ai-stale: <strong id="cards-stale">0</strong>
        </div>

        <pre id="project-map-json" aria-label="Project map JSON preview">(none yet)</pre>
      </section>
    </aside>
  </main>

  <footer role="contentinfo" class="site-footer">
    <div class="footer-inner">
      <small class="muted">¬© AI-Dev-Bot</small>
      <nav aria-label="Footer" role="navigation">
        <a href="/privacy" class="muted small footer-link">Privacy</a>
        <a href="/terms" class="muted small footer-link">Terms</a>
      </nav>
    </div>
  </footer>

  <!-- Project Setup Wizard (modal) -->
  <div
    id="setup-modal"
    class="modal"
    aria-hidden="true"
    role="dialog"
    aria-labelledby="setup-title"
    aria-modal="true"
    data-modal="setup"
    data-modal-open="false"
  >
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-card" role="document" tabindex="-1">
      <h3 id="setup-title">Create or Select a Project</h3>

      <!-- Step 1 -->
      <div id="setup-step-1" class="wizard-step">
        <p class="note">Choose how you want to begin:</p>
        <div class="row">
          <label class="radio">
            <input type="radio" name="setup-mode" value="create" checked />
            <span>Create new project</span>
          </label>
          <label class="radio">
            <input type="radio" name="setup-mode" value="select" />
            <span>Select existing project</span>
          </label>
        </div>
        <div class="row actions-row">
          <button class="btn" id="setup-next" type="button">Next</button>
        </div>
      </div>

      <!-- Step 2A: Create -->
      <div id="setup-step-create" class="wizard-step" hidden>
        <div class="row">
          <label for="create-name" class="visually-hidden">Project name</label>
          <input id="create-name" type="text" placeholder="Project name (optional)" />
        </div>
        <div class="row">
          <label for="create-basedir" class="visually-hidden">Base directory</label>
          <input id="create-basedir" type="text" placeholder="Base directory (optional, defaults to ./projects)" />
        </div>
        <div class="row">
          <label for="create-brief" class="visually-hidden">Brief</label>
          <textarea
            id="create-brief"
            rows="6"
            placeholder="Short brief: what should we build and for whom? You can refine the full description later in the app."
          ></textarea>
        </div>
        <div class="row actions-row">
          <button class="btn ghost" id="setup-back-1" type="button">Back</button>
          <button class="btn" id="setup-create" type="button">Create</button>
        </div>
        <small id="create-status" class="status"></small>
      </div>

      <!-- Step 2B: Select -->
      <div id="setup-step-select" class="wizard-step" hidden>
        <div class="row">
          <label for="setup-project-select" class="visually-hidden">Existing projects</label>
          <select id="setup-project-select"></select>
          <button id="setup-rescan" class="btn secondary" type="button">Rescan</button>
        </div>
        <div class="row actions-row">
          <button class="btn ghost" id="setup-back-2" type="button">Back</button>
          <button class="btn" id="setup-select-btn" type="button">Select</button>
        </div>
        <small id="setup-select-status" class="status"></small>
      </div>
    </div>
  </div>

  <!-- Update Descriptions Modal -->
  <div
    id="update-modal"
    class="modal"
    aria-hidden="true"
    role="dialog"
    aria-labelledby="update-title"
    aria-modal="true"
    data-modal="update"
    data-modal-open="false"
  >
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-card" role="document" tabindex="-1">
      <h3 id="update-title">Edit project description</h3>
      <p class="note">
        This is the one description for your app. It becomes <code>app_descrip.txt</code> and drives the AI.
      </p>
      <div class="row">
        <label for="update-text" class="visually-hidden">Project description</label>
        <textarea
          id="update-text"
          rows="8"
          placeholder="What are you building? (this becomes app_descrip.txt and drives the AI). Include goals, users, constraints, tech stack, and anything else the bot should know."
        ></textarea>
      </div>
      <div class="row actions-row">
        <button class="btn ghost" id="update-cancel" data-close-modal type="button">Cancel</button>
        <button class="btn" id="update-submit" type="button">Save description</button>
      </div>
      <small id="update-status" class="status"></small>
    </div>
  </div>

  <!-- Plan Approval Modal -->
  <div
    id="plan-modal"
    class="modal"
    aria-hidden="true"
    role="dialog"
    aria-labelledby="plan-title"
    aria-label="Plan approval dialog"
    aria-modal="true"
    data-modal="plan"
    data-modal-open="false"
    data-aidev-target="plan-modal"
  >
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-card" role="document" tabindex="-1">
      <h3 id="plan-title">Approve Plan: Recommendations</h3>

      <p class="note">
        Review the proposed changes below, then click <strong>Approve Selected</strong> to continue or
        <strong>Cancel</strong> to stop this run.
      </p>
      <p class="note">
        All recommendations are selected by default ‚Äî uncheck anything you don‚Äôt want to include in this run.
      </p>

      <div class="inline-actions actions-row">
        <input
          id="plan-search"
          class="search"
          type="text"
          placeholder="Filter by title, summary, or file path‚Ä¶"
        />
        <button id="plan-select-all" class="btn secondary" type="button" title="Select all recommendations">Select all</button>
        <button id="plan-select-none" class="btn ghost" type="button" title="Clear all selections">Clear</button>
      </div>

      <!-- List of recommendations (checkbox + summary) -->
      <fieldset id="rec-list" class="rec-list" role="group" aria-labelledby="plan-title"></fieldset>

      <!-- Optional summary of the currently selected recommendation(s) -->
      <div id="plan-selected-summary" class="plan-selected-summary">
        <h4>Selected recommendation</h4>
        <p class="muted">
          Select a recommendation above to see a quick summary here. This area can be used to highlight
          the highest-impact changes or risk level.
        </p>
      </div>

      <div class="row actions-row">
        <button class="btn ghost" id="plan-cancel" data-close-modal type="button">Cancel</button>
        <button class="btn" id="plan-approve" type="button">Approve Selected</button>
      </div>
      <small id="plan-status" class="status" aria-live="polite"></small>
    </div>
  </div>

  <!-- Pre-Apply Checks Modal -->
  <div
    id="checks-modal"
    class="modal"
    aria-hidden="true"
    role="dialog"
    aria-labelledby="checks-title"
    aria-modal="true"
    data-modal="checks"
    data-modal-open="false"
  >
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-card" role="document" tabindex="-1">
      <h3 id="checks-title">Pre-Apply Checks</h3>
      <div id="checks-body"></div>
      <div class="row actions-row">
        <button class="btn ghost" id="checks-reject" type="button">Reject</button>
        <button class="btn" id="checks-approve" type="button" disabled>Approve</button>
      </div>
    </div>
  </div>

  <!-- Small live region for announcing server-sent events (SSE) or other programmatic updates.
       App.js should write concise, user-facing messages here. Kept visually hidden but accessible to
       assistive technologies. -->
  <div id="sse-announcer" class="visually-hidden" role="status" aria-live="polite" aria-atomic="true" data-aidev-target="announcer"></div>

  <!-- Defensive fallbacks only ‚Äî full onboarding / SSE / advanced-toggle logic moved to /ui/app.js -->
  <script>
    // Minimal no-op fallbacks so pages that load before app.js don't throw when calling these helpers.
    window.updateConnStatus = window.updateConnStatus || function(){};
    window.finalizeStreamOnFinish = window.finalizeStreamOnFinish || function(){};
    window.__AIDEV_ADVANCED_TOGGLE_INITIALIZED = window.__AIDEV_ADVANCED_TOGGLE_INITIALIZED || false;
  </script>

  <!-- App -->
  <script src="/ui/app.js" defer></script>
</body>
</html>